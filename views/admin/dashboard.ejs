<style>
    .dashboard-container {
        min-height: 100vh;
    }

    .card-counter {
        box-shadow: 2px 2px 10px #DADADA;
        margin: 5px;
        padding: 20px 10px;
        background-color: #fff;
        border-radius: 5px;
        transition: .3s linear all;
    }

    .card-counter:hover {
        box-shadow: 4px 4px 20px #DADADA;
        transition: .3s linear all;
    }

    .card-counter.primary {
        background-color: #007bff;
        color: #FFF;
    }

    .card-counter.danger {
        background-color: #ef5350;
        color: #FFF;
    }

    .card-counter.success {
        background-color: #66bb6a;
        color: #FFF;
    }

    .card-counter.info {
        background-color: #26c6da;
        color: #FFF;
    }

    .card-counter.warning {
        background-color: purple;
        color: #FFF;
    }

    .card-counter.orange {
        background-color: orange;
        color: #FFF;
    }

    .card-counter i {
        font-size: 5em;
        opacity: 0.2;
    }

    .card-counter .count-numbers {
        position: absolute;
        right: 35px;
        top: 20px;
        font-size: 32px;
        display: block;
    }

    .card-counter .count-name {
        position: absolute;
        right: 35px;
        top: 65px;
        font-style: italic;
        text-transform: capitalize;
        opacity: 0.5;
        display: block;
        font-size: 18px;
    }

    .date-form {
        padding: 0 8rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
</style>

<%- include('navbar') %>
    <div class="container dashboard-container">
        <div class="row mt-5">
            <div class="col-md-12 mb-3">
                <h2>Sales Report</h2>
            </div>
            <div class="col-md-4">
                <div class="card-counter info">
                    <i class="fa-solid fa-hand-holding-dollar"></i>
                    <span class="count-numbers">
                        &#8377; <%= dailyReport.toLocaleString() %>
                    </span>
                    <span class="count-name">Daily Sale : <%= new Date().toDateString() %></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-counter success">
                    <i class="fa-solid fa-coins"></i>
                    <span class="count-numbers">
                        &#8377; <%= weeklyReport.toLocaleString() %>
                    </span>
                    <span class="count-name">weeklyReport :</span>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card-counter warning">
                    <i class="fa-solid fa-sack-dollar"></i>
                    <span class="count-numbers">
                        &#8377; <%= monthlyReport.toLocaleString() %>
                    </span>
                    <span class="count-name">Monthly Sale : <span id="current-month"></span></span>
                </div>
            </div>
        </div>
        <div class="row mt-5">
            <div class="col-md-12">
                <div class="card-counter orange">
                    <i class="fa-solid fa-circle-dollar-to-slot"></i>
                    <span class="count-numbers" id="custom-sale-display">&#8377; 00</span>
                    <form class="date-form" id="custom-sales-form">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="startDate">Starting Date</label>
                                <input id="startDate" class="form-control" type="date" name="startDate" />
                                <label id="startDate-validate" class="text-danger"></label>
                            </div>
                            <div class="col-md-6">
                                <label for="endDate">Ending Date</label>
                                <input id="endDate" class="form-control" type="date" name="endDate" />
                                <label id="endDate-validate" class="text-danger"></label>
                            </div>
                            <div class="col-md-6">
                                <label for="report-select">Sales Duration</label>
                                <select class="form-select" aria-label="Default select example" id="report-select">
                                    <option value="1" selected>Today</option>
                                    <option value="2">One Week</option>
                                    <option value="3">One Month</option>
                                    <option value="4">Six Months</option>
                                    <option value="5">One Year</option>
                                </select>
                                <label id="report-select-validate" class="text-danger"></label>
                            </div>
                            <div class="col-md-6">
                                <label for="report-format">Report Format</label>
                                <select class="form-select" aria-label="Default select example" id="report-format">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                </select>
                                <label id="report-format-validate" class="text-danger"></label>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-dark" type="submit">Generate Report</button>
                            <button class="btn btn-dark" type="button" id="download-report">Download Report</button>
                        </div>
                    </form>

                    <span class="count-name">Custom Date Sale</span>
                </div>
            </div>
            <!-- <div class="col-md-6">
                <div class="card-counter ">
                    <i class="fa-solid fa-file-pdf"></i>
                    <span class="count-numbers" id="custom-sale-display">Generate PDF report</span>
                    <form class="date-form" id="custom-sales-form">
                        <div>
                            <label for="report-select">Sales duration</label>
                            <select class="form-select" aria-label="Default select example" id="report-select">
                                <option value="1" selected>Today</option>
                                <option value="2">One Week</option>
                                <option value="3">One Month</option>
                                <option value="3">Six Month</option>
                                <option value="3">One Year</option>
                            </select>
                            <label for="report-select" class="sales-validate text-danger"></label>
                        </div>
                        <div>
                            <label for="endDate">End</label>
                            <input id="endDate" class="form-control" type="date" name="endDate" />
                            <label for="endDate" class="sales-validate text-danger"></label>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-info" type="submit">Generate Report</button>
                        </div>
                    </form>
                </div>
            </div> -->
        </div>


        <!-- table for generating the sales report -->
        <div class="row my-5">
            <div class="table-responsive col-md-12">
                <table class="table">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col" class="text-center py-3">sl.no</th>
                            <th scope="col" class="py-3">Order ID</th>
                            <th scope="col" class="py-3">Ordered Date</th>
                            <th scope="col" class="py-3">Payment Method</th>
                            <th scope="col" class="py-3">Status</th>
                            <th scope="col" class="py-3">Price</th>
                            <!-- <th scope="col" class="text-center py-3">Actions</th> -->
                        </tr>
                    </thead>
                    <tbody>
                        <% orderDetails.forEach((ele,index)=>{ %>
                            <tr>
                                <th scope="row" class="text-center">
                                    <%= index+1 %>
                                </th>
                                <td class="product-name-td">
                                    <%= ele._id %>
                                </td>
                                <td>
                                    <%= ele.createdAt.toDateString() %>
                                </td>
                                <td>
                                    <%= ele.paymentMethod %>
                                </td>
                                <td>
                                    <span class="badge">
                                        <%= ele.orderStatus %>
                                    </span>

                                </td>
                                <td>&#8377;<%= ele.totalPrice.toLocaleString() %>
                                </td>
                                <!-- <td class="text-center">
                                    <a href="/admin/view-order/<%= ele._id %>" id="view-order-button" class="btn" >
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </a>
    
                                </td> -->
                            </tr>
                            <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <%- include('footer') %>

        <script>

            // get the current month
            const getCurrentMonthYear = () => {
                const now = new Date();
                const options = { month: 'long', year: 'numeric' };
                return now.toLocaleDateString('en-US', options);
            }
            document.addEventListener('DOMContentLoaded', (event) => {
                document.getElementById('current-month').innerHTML = getCurrentMonthYear();
            });


            // get the custom date sales report 
            const customDateForm = document.getElementById('custom-sales-form');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');

            customDateForm.addEventListener('submit', (e) => {
                e.preventDefault();

                // Clear previous validation messages
                document.getElementById('startDate-validate').innerHTML = "";
                document.getElementById('endDate-validate').innerHTML = "";
                document.getElementById('report-select-validate').innerHTML = "";
                document.getElementById('report-format-validate').innerHTML = "";

                let validateSale = true;

                // Validate the dates
                if (!startDate.value) {
                    validateSale = false;
                    document.getElementById('startDate-validate').innerHTML = "Start date is required";
                }
                if (!endDate.value) {
                    validateSale = false;
                    document.getElementById('endDate-validate').innerHTML = "End date is required";
                }
                if (new Date(startDate.value) > new Date(endDate.value)) {
                    validateSale = false;
                    document.getElementById('startDate-validate').innerHTML = "Start date cannot be later than end date";
                    document.getElementById('endDate-validate').innerHTML = "End date cannot be earlier than start date";
                }

                if (validateSale) {
                    const URL = "/admin/custom-sales";
                    fetch(URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ startDate: startDate.value, endDate: endDate.value })
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.sale) {
                                document.getElementById('custom-sale-display').innerHTML = "&#8377; " + data.sale;
                            } else {
                                console.log("No sales data available for the selected period");
                            }
                        })
                        .catch((err) => {
                            console.error("Error on getting custom sales report", err);
                        });
                }
            });

            const orderStatusBadge = document.querySelectorAll('.badge')

            orderStatusBadge.forEach((badge) => {
                if (badge.innerHTML.trim().toLocaleLowerCase() === "cancelled") {
                    badge.classList.add('badge-danger')
                }
                if (badge.innerHTML.trim().toLocaleLowerCase() === "delivered") {
                    badge.classList.add('badge-success')
                }
                if (badge.innerHTML.trim().toLocaleLowerCase() === "returned") {
                    badge.classList.add('badge-warning')
                }
                if (badge.innerHTML.trim().toLocaleLowerCase() === "pending") {
                    badge.classList.add('badge-info')
                }
            })

            // download the report
            const salesDownloadFormat=document.querySelector('#report-format')
            const salesDuration=document.querySelector('#report-select')
            salesDuration.addEventListener('change',(e)=>{
                e.preventDefault();
                
            })

            const downloadReport=document.querySelector('#download-report')
            downloadReport.addEventListener('click',(e)=>{
                e.preventDefault()

                let validateSaleDownload=true

                

                const URL="/admin/download-sales-report"

                fetch(URL,{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify({})
                }).then((res)=>{
                    return res.json()
                }).then((data)=>{
                    console.log(data);
                }).catch((err)=>{
                    console.log(`Error on downloading the sales report`);
                })
            })

        </script>